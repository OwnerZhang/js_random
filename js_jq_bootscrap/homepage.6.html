<!DOCTYPE html>
<html>
	<head>
		<meta name="viewport" content="width=device-width,initial-scale=1.0">
		<meta charset="utf-8">
		<title>全国硕士研究生招生考试（大庆师范学院考点）考场监考抽签系统</title>
		<script src="jq/jquery-3.4.1.min.js"></script>
		<script type="text/javascript" src="jq/sweetalert.min.js"></script>
		<link rel="stylesheet" href="bootstrap/css/bootstrap.css" />
		<script type="text/javascript" src="bootstrap/js/bootstrap.min.js"></script>
		<script src="xlsx/xlsx.full.min.js"></script>
		<script src="jq/jquery.table2excel.min.js"></script>
		<link rel="stylesheet" type="text/css" href="jq/sweetalert.css" />
		<link rel="stylesheet" href="bootstrap-4/css/bootstrap.min.css">
		<style type="text/css">
			* {
				margin: 0;
				padding: 0;
			}

			body,
			html {
				width: 100%;
				height: 100%;
			}

			body {
				font-size: 18px;

			}

			.wang-context {
				/* margin-top: 120px; */
				overflow: hidden;
				width: 100%;
			}

			#flag {
				position: absolute;
				right: -60px;
				border-left: 0;
				width: 100px;
				height: 100px;
				line-height: 100px;
				font-size: 40px;
				color: #000;
				top: 50%;
				transform: translateY(-50%);
				text-align: center;
				z-index: 100;
			}

			.teach {
				height: 100%;
				width: 0%;
				background-color: white;
				position: fixed;
				left: 0;
				top: 0;
				transition: all 0.2s;
				z-index: 10000;
			}

			.teach iframe {
				width: 100%;
				height: 100%;
				z-index: 1000;
			}

			.close {
				width: 33%;
			}

			button {
				height: 38px;

			}

			#random {
				width: 100px;
			}

			#output {
				width: 100px;
			}

			#againran {
				margin-right: -5px;
				width: 100px;
			}

			.po {
				width: 100%;
				height: 100%;
				position: relative;
			}

			.txt {
				width: 500%;
				height: 100%;
				top: 50%;
				left: 50%;
				text-align: center;
				transform: translate(-50%, -50%);
				position: absolute;
			}

			#tubiao {
				position: absolute;
				left: 20px;
				top: 0;
			}

			table {
				text-align: center;
				border: 1px;
			}
		</style>
		<script>
			$(function(){
				
				$('#flag').click(function(){
					if($(".teach").hasClass("close")){
						$(".teach").removeClass("close");
						$("#contro").val('>');
						
					}else{
						$(".teach").addClass("close");
						$("#contro").val('<');
						
					}
				})
				
				var datainput=document.getElementById('datainput');
				datainput.onfocus=function(){
					if(this.value=='输入考场范围10-20 30'){
						this.value='';
					};
				};
				datainput.onblur=function(){
					if(this.value==''){
						this.value=='输入考场范围10-20 30';
					}
				}
				
				
			$('#datainput').focus(
				function() {
					if(this.value=='输入考场范围10-20 30') 
					this.value='';
					}
			).blur(
                function() {
					if(this.value=='')
					 this.value='输入考场范围10-20 30'
					 }
        );

			})
			
</script>
	</head>
	<body>
		<div class="teach" style="opacity:1">
			<div id="flag">
				<button class="btn btn-default btn-info" id="contro">></button>
			</div>
			<div class="teach">
				<iframe src="zhinan.html" scrolling="auto"></iframe>
			</div>


		</div>

		<img src="image/图标.png" style="width: 150px;height: 150px;" id="tubiao" />
		<div class="panel panel-default wang-title">
			<div class="panel-body" align="center" style="font-size: 40px; font-family: '宋体';font-weight:bold; background-color: #80CFEF;"
			 class="col-md-12">
				全国硕士研究生招生考试（大庆师范学院考点）考场监考抽签系统<br />
				<span style="font-size: 28px;">计算机科学与信息技术学院技术支持</span>
			</div>
		</div>


		<div class="wang-context">


			<div class="row">

				<!-- 左侧布局 -->
				<div class="col-md-3" id="leftlayout">
					<div class="panel panel-default">
						<div class="panel-body">

							<table class="table">
								<caption>
									<table class="col-md-12	">
										<tr>
											<td>

												<div class="custom-file">
													<input type="file" class="custom-file-input" onchange="importleft(this)" id="file1" accept=".xlsx,.xls" />
													<label for="" class="custom-file-label">请选择人员表</label>
												</div>
											</td>

										</tr>
									</table>
								</caption>
							</table>

							<div id="treeLeftList"></div>

						</div>
					</div>
				</div>


				<!-- 右侧布局 -->
				<div class="col-md-9" id="rightlayout">
					<div class="panel panel-default">
						<div class="panel-body">
							<table class="table">
								<caption>
									<table class="col-md-12">
										<tr>
											<td>

												<div class="custom-file">
													<input type="file" class="custom-file-input" onchange="importright(this)" id="file2" accept=".xlsx,.xls" />
													<label for="" class="custom-file-label">请选择考场表</label>
												</div>
											</td>

											<td>
												<div class="col-md-12">
													<div class="input-group">
														<input type="text" class="form-control" id="datainput" placeholder='输入考场范围10-20 30' style="height: 38px;">
														<span class="input-group-btn">
														</span>
													</div>
												</div>

											</td>
											<td>

												<div class="btn-group btn-group-lg col-md-12">
													<button type="button" class="btn btn-default btn-info" id="btngroup_high" style="color: black; font-weight: bold; border: 1px; background-color: #80CFEF;">快</button>
													<button type="button" class="btn btn-default btn-info" id="btngroup_middle" style="color: black; font-weight: bold; border: 1px; background-color: #80CFEF;">中</button>
													<button type="button" class="btn btn-default btn-info" id="btngroup_low" style="color: black;font-weight: bold; border: 1px; background-color: #80CFEF;">慢</button>
												</div>

											</td>

											<td>
												<button type="button" class="btn btn-info btn-lg" onclick="partition()" id="rand" var="random" style="background-color: #80CFEF;color: black;width: 100px;">随机分配</button>
											</td>
											<td>
												<button type="button" class="btn btn-info btn-lg  col-md-12" onclick="againrand()" style="margin-right:-30px; background-color: #80CFEF;width: 100px; color: black;"
												 id="againran" var="repeat">重置</button>
											</td>

											<td>
												<button type="button" class="btn btn-success btn-lg" id="output" onclick="exp()" style="color: black;">导出Excel</button>
											</td>
										</tr>
									</table>
									<div id="treeRightList">
									</div>
								</caption>
							</table>
						</div>
					</div>
				</div>
			</div>
		</div>
	</body>

	<script>
		document.onkeydown = function(event) {

			var e = event || window.event || arguments.callee.caller.arguments[0];

			if (e && e.keyCode == 27) {

				clearInterval(interval);
				interval = null;
			}

			if (e && e.keyCode == 113) { // 按 F2 
				randomtables();
			}
		};


		var speed = 100;


		$('#btngroup_high').click(function() {
			speed = 100;
			swal("调整速度为:" + speed);
		})
		$('#btngroup_middle').click(function() {
			speed = 800;
			swal("调整速度为:" + speed);
		})
		$('#btngroup_low').click(function() {
			speed = 1100;
			swal("调整速度为:" + speed);
		})

		var arr; //全局对象
		var brr;
		var totals = new Array();
		var list; //全局json对象
		var rightlist;
		var leftlist;

		var interval = null;
		var i = 0;
		var count = 0;
		var man = 0;
		var woman = 0;
		var arr1 = new Array();
		var sign = 0;
		var row = 1;
		var column = 0;

		// 生成左表
		function initLeftTable() {
			var html = '<table class="table table-bordered" id="outtable">';
			console.log(leftlist);
			// html += '<caption align="center">参选教师</caption>';
			html += '<th>' + "序号" + '</th>';
			html += '<th>' + "姓名" + '</th>';
			html += '<th>' + "性别" + '</th>';
			html += '<th>' + "学院" + '</th>';

			for (var j in leftlist) {
				html += '<tr>';
				html += '<td>' + leftlist[j]['序号'] + '</td>';
				html += '<td>' + leftlist[j]['姓名'] + '</td>';
				html += '<td>' + leftlist[j]['性别'] + '</td>';
				html += '<td>' + leftlist[j]['学院'] + '</td>';
				html += '</tr>'
			}
			html += '</table>';

			$('#treeLeftList').append(html);
		}


		//生成右表
		function initRighTable() {
			var html = '<table class="table table-bordered" id="randomtable1">';
			console.log(rightlist);
			// html += '<caption align="top">随机结果</caption>';
			html += '<th>' + "序号" + '</th>';
			html += '<th>' + "考场号" + '</th>';
			html += '<th>' + "科目1" + '</th>';
			html += '<th>' + "科目2" + '</th>';
			html += '<th>' + "科目3" + '</th>';
			html += '<th>' + "科目4" + '</th>';
			html += '<th>' + "地点" + '</th>';
			html += '<th>' + "监考员甲" + '</th>';
			html += '<th>' + "监考员乙" + '</th>';

			for (var j in rightlist) {
				html += '<tr id="' + (parseInt(j) + 1) + '">';
				html += '<td>' + rightlist[j]['序号'] + '</td>';
				html += '<td>' + rightlist[j]['考场号'] + '</td>';
				html += '<td>' + rightlist[j]['科目1'] + '</td>';
				html += '<td>' + rightlist[j]['科目2'] + '</td>';
				html += '<td>' + rightlist[j]['科目3'] + '</td>';
				html += '<td>' + rightlist[j]['科目4'] + '</td>';
				html += '<td>' + rightlist[j]['地点'] + '</td>';
				html += '<td><div class="po"><div class="txt">' + '' + '</div></div></td>';
				html += '<td><div class="po"><div class="txt">' + '' + '</div></div></td>';
				html += '</tr>'
			}



			html += '</table>';
			$('#treeRightList').append(html);

			var html = '<table class="table table-bordered" id="randomtable2">';

			html += '<tr>'
			html += '<td colspan="9" >' + '备用监考' + '</td>';
			html += '</tr>'


			html += '</table>';
			$('#treeRightList').append(html);


		}


		//导入
		function importleft(obj) {
			var wb; //读取完成的数据
			var rABS = false; //是否将文件读取为二进制字符串
			if (!obj.files) {
				return;
			}
			var f = obj.files[0];
			var reader = new FileReader();
			reader.onload = function(e) {
				var data = e.target.result;
				if (rABS) {
					wb = XLSX.read(btoa(fixdata(data)), { //手动转化
						type: 'base64'
					});
				} else {
					wb = XLSX.read(data, {
						type: 'binary'
					});
				}
				list = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
				leftlist = list;
				$('#outtable').remove();
				initLeftTable();

			};
			if (rABS) {
				reader.readAsArrayBuffer(f);
			} else {
				reader.readAsBinaryString(f);
			}

		}



		function importright(obj) {
			var wb; //读取完成的数据
			var rABS = false; //是否将文件读取为二进制字符串
			if (!obj.files) {
				return;
			}
			var f = obj.files[0];
			var reader = new FileReader();
			reader.onload = function(e) {
				var data = e.target.result;
				if (rABS) {
					wb = XLSX.read(btoa(fixdata(data)), { //手动转化
						type: 'base64'
					});
				} else {
					wb = XLSX.read(data, {
						type: 'binary'
					});
				}
				list = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
				rightlist = list;
				$('#randomtable1').remove();
				initRighTable();
			};
			if (rABS) {
				reader.readAsArrayBuffer(f);
			} else {
				reader.readAsBinaryString(f);
			}

		}

		function fixdata(data) { //文件流转BinaryString
			var o = "",
				l = 0,
				w = 10240;
			for (; l < data.byteLength / w; ++l) o += String.fromCharCode.apply(null, new Uint8Array(data.slice(l * w, l * w + w)));
			o += String.fromCharCode.apply(null, new Uint8Array(data.slice(l * w)));
			return o;
		}


		//导出
		function exp() {
			if (($('#randomtable1').length > 0) && ($('#outtable').length > 0)) {
				tablesToExcel(['randomtable1', 'randomtable2'], ['监考', '备考'], "监考分配.xls", "Excel");
			} else {
				swal("OMG!", "请添加数据!", "error");
			}
		}
		//导出excel包含多个sheet
		//tables:tableId的数组;wsbames:sheet的名字数组;wbname:工作簿名字;appname:Excel
		function tablesToExcel(tables, wsnames, wbname, appname) {

			var uri = 'data:application/vnd.ms-excel;base64,',
				tmplWorkbookXML =
				'<?xml version="1.0"?><?mso-application progid="Excel.Sheet"?><Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet" xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet">' +
				'<DocumentProperties xmlns="urn:schemas-microsoft-com:office:office"><Author>Axel Richter</Author><Created>{created}</Created></DocumentProperties>' +
				'<Styles>' +
				'<Style ss:ID="Currency"><NumberFormat ss:Format="Currency"></NumberFormat></Style>' +
				'<Style ss:ID="Date"><NumberFormat ss:Format="Medium Date"></NumberFormat></Style>' +
				'</Styles>' +
				'{worksheets}</Workbook>',
				tmplWorksheetXML = '<Worksheet ss:Name="{nameWS}"><Table>{rows}</Table></Worksheet>',
				tmplCellXML = '<Cell{attributeStyleID}{attributeFormula}><Data ss:Type="{nameType}">{data}</Data></Cell>',
				base64 = function(s) {
					return window.btoa(unescape(encodeURIComponent(s)))
				},
				format = function(s, c) {
					return s.replace(/{(\w+)}/g, function(m, p) {
						return c[p];
					})
				}

			var ctx = "";
			var workbookXML = "";
			var worksheetsXML = "";
			var rowsXML = "";

			for (var i = 0; i < tables.length; i++) {
				if (!tables[i].nodeType) tables[i] = document.getElementById(tables[i]);

				//           控制要导出的行数
				for (var j = 0; j < tables[i].rows.length; j++) {
					rowsXML += '<Row>';

					for (var k = 0; k < tables[i].rows[j].cells.length; k++) {
						var dataType = tables[i].rows[j].cells[k].getAttribute("data-type");
						var dataStyle = tables[i].rows[j].cells[k].getAttribute("data-style");
						var dataValue = tables[i].rows[j].cells[k].getAttribute("data-value");
						dataValue = (dataValue) ? dataValue : tables[i].rows[j].cells[k].innerHTML;
						var dataFormula = tables[i].rows[j].cells[k].getAttribute("data-formula");
						dataFormula = (dataFormula) ? dataFormula : (appname == 'Calc' && dataType == 'DateTime') ? dataValue : null;
						ctx = {
							attributeStyleID: (dataStyle == 'Currency' || dataStyle == 'Date') ? ' ss:StyleID="' + dataStyle + '"' : '',
							nameType: (dataType == 'Number' || dataType == 'DateTime' || dataType == 'Boolean' || dataType == 'Error') ?
								dataType : 'String',
							data: (dataFormula) ? '' : dataValue,
							attributeFormula: (dataFormula) ? ' ss:Formula="' + dataFormula + '"' : ''
						};
						rowsXML += format(tmplCellXML, ctx);
					}
					rowsXML += '</Row>'
				}
				ctx = {
					rows: rowsXML,
					nameWS: wsnames[i] || 'Sheet' + i
				};
				worksheetsXML += format(tmplWorksheetXML, ctx);
				rowsXML = "";
			}

			ctx = {
				created: (new Date()).getTime(),
				worksheets: worksheetsXML
			};
			workbookXML = format(tmplWorkbookXML, ctx);

			//       查看后台的打印输出
			//console.log(workbookXML);

			var link = document.createElement("A");
			link.href = uri + base64(workbookXML);
			link.download = wbname || 'Workbook.xls';
			link.target = '_blank';
			document.body.appendChild(link);
			link.click();
			document.body.removeChild(link);

		}

		//随机
		function randomtables() {
			if (($('#randomtable1').length > 0) && ($('#outtable').length > 0)) {
				if ($("#rand").attr("var") == "random") {
					$("#rand").attr({
						"disabled": "disabled"
					});
					randleft();
					start();
				}
			} else {
				swal("OMG!", "请添加数据!", "error");
			}

			function start() {
				interval = setInterval(rand, speed);
			}

		}



		function randleft() {
			while (arr1.length != leftlist.length) {
				var index = Math.floor(Math.random() * leftlist.length);
				if (arr1.indexOf(leftlist[index]) == -1) {
					arr1.push(leftlist[index])
				}
			}
		}

		function rand() {
			if (count < brr.length * 2) {
				var num = Math.floor(Math.random() * brr.length)
				var tr = $("#randomtable1 tbody").children('tr').eq(brr[num]);
				var td;
				if (man == brr.length) {
					td = tr.children('td').eq(8).children(".po").children(".txt");

				} else if (woman == brr.length) {
					td = tr.children('td').eq(7).children(".po").children(".txt");

				} else {
					if (arr1[i].性别 == '男') {
						td = tr.children('td').eq(7).children(".po").children(".txt");
					} else {
						td = tr.children('td').eq(8).children(".po").children(".txt");
					}
				}
				if (td.text() == '') {
					$("#outtable").find("tr:nth-child(" + (arr1[i].序号 + 1) + ")").css("background", "aqua")
					$("#outtable").find("tr:nth-child(" + (arr1[i].序号 + 1) + ")").fadeOut(speed);
					console.log(brr[num])
					document.getElementById((num + 1) + "").scrollIntoView(false);
					td.text(arr1[i].姓名).css("color", "#17a2b8")
					td.animate({
						fontSize: '3em'
					}, "normal");
					td.animate({
						fontSize: '1em'
					}, "normal");
					if (arr1[i].性别 == '男') {
						man++;
						if (man == brr.length + 1) {
							man = brr.length;
						}
					} else {
						woman++;
						if (woman == brr.length + 1) {
							woman = brr.length;
						}
					}
					if (i == brr.length * 2 - 1) {
						i = brr.length * 2 - 1
					} else if (i == leftlist.length - 1) {
						swal("人员不足!");
						clearInterval(interval);
						interval = null;
					} else {
						i++
					}
					count++;
				} else {
					while (1 == 1) {
						var num = Math.floor(Math.random() * brr.length);
						var tr = $("#randomtable1 tbody").children('tr').eq(brr[num]);
						var td;
						if (man == brr.length) {
							td = tr.children('td').eq(8).children(".po").children(".txt");

						} else if (woman == brr.length) {
							td = tr.children('td').eq(7).children(".po").children(".txt");

						} else {
							if (arr1[i].性别 == '男') {
								td = tr.children('td').eq(7).children(".po").children(".txt");
							} else {
								td = tr.children('td').eq(8).children(".po").children(".txt");
							}
						}
						if (td.text() == '') {
							//调用方法的淡出
							$("#outtable").find("tr:nth-child(" + (arr1[i].序号 + 1) + ")").css("background", "aqua")
							$("#outtable").find("tr:nth-child(" + (arr1[i].序号 + 1) + ")").fadeOut(speed);
							console.log(brr[num])
							// animate({fontSize:'3em'},"slow");
							document.getElementById((num + 1) + "").scrollIntoView(false);
							td.text(arr1[i].姓名).css("color", "#17a2b8")
							td.animate({
								fontSize: '3em'
							}, "normal");
							td.animate({
								fontSize: '1em'
							}, "normal");
							if (arr1[i].性别 == '男') {
								man++;
								if (man == brr.length + 1) {
									man = brr.length;
								}
							} else {
								woman++;
								if (woman == brr.length + 1) {
									woman = brr.length;
								}
							}
							if (i == brr.length * 2 - 1) {
								i = brr.length * 2 - 1
							} else if (i == leftlist.length - 1) {
								swal("人员不足!");
								clearInterval(interval);
								interval = null;
							} else {
								i++
							}
							count++;
							break;
						}
					}
				}
			} else if (count == brr.length * 2) {
				i++;
				$("#outtable").find("tr:nth-child(" + (arr1[i].序号 + 1) + ")").css("background", "aqua")
				$("#outtable").find("tr:nth-child(" + (arr1[i].序号 + 1) + ")").fadeOut(speed);
				if (sign == 0) {
					for (var k = 0; k < Math.ceil((arr1.length - brr.length * 2) / 9); k++) {
						$("#randomtable2").append(
							"<tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>");
						sign++;
					}
				}
				td = $("#randomtable2 tbody").children('tr').eq(row).children('td').eq(column);
				td.text(arr1[i].姓名).css("color", "#17a2b8")
				if (column == 8) {
					column = 8;
					if (row == Math.ceil((arr1.length - brr.length * 2) / 9)) {
						row = Math.ceil((arr1.length - brr.length * 2) / 9);
					} else {
						row++;
						column = 0;
					}
				} else {
					column++;
				}
				document.getElementById("randomtable2").scrollIntoView(false);
				if (i == leftlist.length - 1) {
					clearInterval(interval);
					interval = null;
					swal("Good!", "人员随机分配完成!", "success");
					$('#leftlayout').hide();
					$('#rightlayout').removeClass("col-md-9");
					$('#rightlayout').addClass("col-md-12");
				}
			}

		}

		function againrand() {
			if (($('#randomtable1').length > 0) && ($('#outtable').length > 0)) {
				speed = 800;
				if ($("#againran").attr("var") == "repeat") {
					$("#rand").removeAttr("disabled");
				}
				clearInterval(interval);
				interval = null;
				i = 0;
				count = 0;
				man = 0;
				woman = 0;
				sign = 0;
				row = 1;
				column = 0;
				arr1 = new Array();
				$('#leftlayout').show();
				$('#rightlayout').removeClass("col-md-12");
				$('#rightlayout').addClass("col-md-9");
				$('#outtable').remove();
				initLeftTable();
				$('#randomtable1').remove();
				$('#randomtable2').remove();
				initRighTable();
			} else {
				swal("OMG!", "请导入数据！", "error");
			}
		}
		//考场范围
		function partition() {
			if (($('#randomtable1').length > 0) && ($('#outtable').length > 0)) {
				var str = $('#datainput').val();
				if (str == '') {
					for (var j = 1; j <= rightlist.length; j++) {
						totals.push(j);
					}
				} else if (str == '输入考场范围10-20 30') {
					for (var j = 1; j <= rightlist.length; j++) {
						totals.push(j);
					}
				} else {
					arr = str.split(' ');
					console.log(arr)
					for (var i = 0; i < arr.length; i++) {
						var test = /^\d+$/.test(arr[i]);
						if (test == true) {
							if (parseInt(arr[i]) < 0) {
								swal("OMG!", "请保证数字大于0!", "error");
							} else {
								totals.push(parseInt(arr[i]));
							}
						} else {
							if (arr[i].indexOf("-") != -1 && arr[i].substr(0, 1) != '-') {
								var crr = arr[i].split("-");
								for (var j = parseInt(crr[0]); j <= parseInt(crr[1]); j++) {
									if (j < 0) {
										swal("OMG!", "请保证数字大于0!", "error");
									} else {
										totals.push(j);
									}
								}
							} else {
								totals = new Array();
								swal("OMG!", "请检查输入的格式,两组数之间是否有空格,是否大于0，是否超出长度!", "error");

							}
						}
					}
				}
				Toreorder();
				var rightlength = rightlist.length;
				console.log(brr[brr.length - 1]);
				if ((brr[brr.length - 1] > rightlength)) {
					swal("OMG!", "请检查考场范围!", "error");
					totals = [];
				} else {
					totals = [];
					randomtables();
				}
			} else {
				swal("OMG!", "请添加考场信息!", "error");
			}
		}


		//去重排序
		function Toreorder() {
			brr = [];
			//第一步去重
			for (var i = 0; i < totals.length; i++) {
				brr.indexOf(totals[i]) === -1 ? brr.push(totals[i]) : '';
			}
			//第二步排序
			brr.sort(function(a, b) {
				return a - b;
			})
			return brr;
		}
	</script>

</html>
